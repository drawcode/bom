<?py app = bom.bom_json['app'] ?>
<?py app_name = bom.to_camel_cap(app,'_') ?>
-- -----------------------------------------------------------------------------
-- SQL SETUP 
-- -----------------------------------------------------------------------------
-- TABLES

/*
<?py for model in bom.bom_json['models']: ?>
    <?py if bom.should_generate_data(model['id']):?>
        <?py model_id = model['id'] ?>
        <?py model_name = bom.to_camel_cap(model['id'],'_') ?>
        
DROP TABLE IF EXISTS "#{model_id}" CASCADE;
    
    <?py #endif ?>
<?py #endif ?>
*/

<?py for model in bom.bom_json['models']: ?>
    <?py if bom.should_generate_data(model['id']):?>
        <?py model_id = model['id'] ?>
        <?py model_name = bom.to_camel_cap(model['id'],'_') ?>
        
CREATE TABLE "#{model_id}" 
(
        <?py inc = 0 ?>
        <?py for item, item_data in bom.bom_model_properties_extended(model_id).iteritems() : ?>
            <?py if inc == 0: ?>
    "#{item}" #{bom.bom_data_type_table_formatted(item_data)}
            <?py else: ?>
    , "#{item}" #{bom.bom_data_type_table_formatted(item_data)}
            <?py #endif ?>
            <?py if item_data['type'] == 'datetime': ?>
                --CONSTRAINT DF_#{model_id}_#{item} DEFAULT GETDATE()
            <?py #endif ?>
            <?py if item_data['type'] == 'bool': ?>
                --CONSTRAINT DF_#{model_id}_#{item}_bool DEFAULT 1
            <?py #endif ?>
            <?py inc = inc + 1 ?>
        <?py #end ?>
);

ALTER TABLE "#{model_id}" ADD PRIMARY KEY ("uuid");
    
    <?py #endif ?>
<?py #endif ?>


-- result / return types
/*
<?py for model in bom.bom_json['models']: ?>
    <?py if bom.should_generate_data(model['id']):?>
        <?py model_id = model['id'] ?>
        <?py model_name = bom.to_camel_cap(model['id'],'_') ?>
        
DROP type IF EXISTS "#{model_id}_result" CASCADE;
    
    <?py #endif ?>
<?py #endif ?>
*/

<?py for model in bom.bom_json['models']: ?>
    <?py if bom.should_generate_data(model['id']):?>
        <?py model_id = model['id'] ?>
        <?py model_name = bom.to_camel_cap(model['id'],'_') ?>
CREATE TYPE "#{model_id}_result" as
(
    total_rows bigint
        <?py inc = 0 ?>
        <?py for item, item_data in bom.bom_model_properties_extended(model_id).iteritems() : ?>
            <?py if inc == 0: ?>
    , "#{item}" #{bom.bom_data_type_type_formatted(item_data)}
            <?py else: ?>
    , "#{item}" #{bom.bom_data_type_type_formatted(item_data)}
            <?py #endif ?>
            <?py inc = inc + 1 ?>
        <?py #end ?>
);    
    <?py #endif ?>
<?py #endif ?>
